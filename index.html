<meta charset="utf-8">
<body style="max-width:800px">
<h1>SQL Trainer</h1>
<h2>Tehtävä</h2>
<p id="task"></p>
<h2>Esimerkki</h2>
<div id="example"></div>
</fieldset>
<h2>Lähetä vastaus</h2>
Kysely:<br>
<textarea rows=5 cols=80 id=query>SELECT O.nimi, COUNT(K.id) FROM Opettajat O, Kurssit K WHERE K.opettaja_id = O.id GROUP BY O.id;</textarea>
<br><br>
<button onclick="check();">Tarkasta</button>
<div id="verdict"></div>
<script src="dist/sql-wasm.js"></script>
<script>

function sql_run(context,query,what) {
    config = {locateFile: filename => `dist/${filename}`};

    initSqlJs(config).then(function(SQL){
        var db = new SQL.Database();
        db.run(context);
        try {
            var result = db.exec(query);
            sql_result(result,what);
        } catch(error) {
            sql_error(error,what);
        }
    });
}

function render_table(data,name) {
    if (data.length == 0) return "";
    data = data[0];
    var table = "";
    table += "<i>"+name+"</i>";
    table += "<table border>";
    table += "<tr>";
    for (var i = 0; i < data.columns.length; i++) {
        table += "<th>"+data.columns[i]+"</th>";
    }
    table += "</tr>";
    for (var i = 0; i < data.values.length; i++) {
        table += "<tr>";
        for (var j = 0; j < data.values[i].length; j++) {
            table += "<td>"+data.values[i][j]+"</td>";
        }
        table += "</tr>";
    }
    table += "</table>";
    return table;
}

function render_tables(data) {
    var html = "";
    html += "<fieldset><legend><b>Taulut</b></legend>";
    html += "<table><tr valign=top>";
    for (var i = 0; i < data.length; i++) {
        if (i != 0) html += "<td width=20></td>";
        html += "<td>"+render_table(data[i],table_names[i])+"</td>";
    }
    html += "</tr></table>";
    html += "</fieldset>";
    return html;
}

function render_plain(data) {
    if (data.length == 0) return "";
    data = data[0];
    var lines = [];
    for (var i = 0; i < data.values.length; i++) {
        var line = "";
        for (var j = 0; j < data.values[i].length; j++) {
            if (j != 0) line += "|";
            line += data.values[i][j];
        }
        lines.push(line);
    }
    return lines;
}

function render_result(data,title) {
    var html = "";
    html += "<fieldset><legend><b>"+title+"</b></legend>";
    html += "<table border>";
    for (var i = 0; i < data.length; i++) {
        html += "<tr>";
        var parts = data[i].split("|");
        for (var j = 0; j < parts.length; j++ ){
            html += "<td>"+parts[j]+"</td>";
        }
        html += "</tr>";
    }
    html += "</table>";
    html += "</fieldset>";
    return html;
}

function same(a,b) {
    if (a.length != b.length) return false;
    var c = [], d = [];
    for (var i = 0; i < a.length; i++) {
        c.push(a[i]);
        d.push(b[i]);
    }
    c.sort(); d.sort();
    for (var i = 0; i < a.length; i++) {
        if (c[i] != d[i]) return false;
    }
    return true;
}

var table_names = [];
var table_data;

function sql_result(result,what) {
    if (what[0] == "example") {
        table_data[my_test].push(result);
        my_table++;
        if (my_table < tables.length) {
            show_example();
        } else {
            if (my_test == 0) {
                var html = "";
                html += render_tables(table_data[0]);
                html += "<br>";
                html += render_result(results[0],"Haluttu tulos");
                document.getElementById("example").innerHTML = html;
            }
            my_table = 0;
            my_test++;
            if (my_test < tests.length) {
                show_example();
            }
        }
    }
    if (what[0] == "test") {
        var verdict = document.getElementById("verdict");
        var plain = render_plain(result);
        var correct = same(results[what[1]],plain);
        var message = correct ? "<font color=green>oikein</font>" : "<font color=red>väärin</font>";
        verdict.innerHTML += "<h2>Testi "+(what[1]+1)+" ("+message+")</h2>";
        verdict.innerHTML += render_tables(table_data[what[1]]);
        verdict.innerHTML += render_result(results[what[1]],"Haluttu tulos");
        verdict.innerHTML += render_result(plain,"Kyselysi tulos");
        my_test++;
        if (my_test < tests.length) check_test();
    }
}


function sql_error(error,what) {
    var verdict = document.getElementById("verdict");
    verdict.innerHTML += "<br><font color=red>Virhe kyselyssä:</font><br>"+error;
}

var tables, tests, results;
var tests;

function parse_task(data) {
    var lines = data.split("\n");
    var mode = 0;
    var task = document.getElementById("task");
    task.innerHTML = "";
    tables = [];
    tests = [];
    results = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (line == "TASK") {
            mode = 1;
        } else if (line == "TABLES") {
            mode = 2;
        } else if (line == "TEST") {
            mode = 3;
            tests.push([]);
            results.push([]);
        } else if (line == "RESULT") {
            mode = 4;
        } else if (line == "") {
        } else {
            if (mode == 1) {
                task.innerHTML += line+" ";
            } else if (mode == 2) {
                tables.push(line);
            } else if (mode == 3) {
                tests[tests.length-1].push(line);
            } else if (mode == 4) {
                results[tests.length-1].push(line);
            }
        }
    }
}

function read_task(file) {
    var x = new XMLHttpRequest();
    x.onreadystatechange = function() {
        if (x.readyState == 4 && x.status == 200) {
            parse_task(x.responseText);
            my_test = my_table = 0;
            show_example();
        }
    }
    x.open("GET",file);
    x.send();
}

var my_test, my_table;

function show_example() {
    if (my_test == 0 && my_table == 0) table_data = [];
    if (my_table == 0) table_data.push([]);
    var context = "";
    for (var i = 0; i < tables.length; i++) {
        context += tables[i];
    }
    for (var i = 0; i < tests[my_test].length; i++) {
        context += tests[my_test][i];
    }
    var parts = tables[my_table].split(" ");
    var table = parts[2];
    table_names.push(table);
    sql_run(context,"SELECT * FROM "+table+";",["example",my_table]);
}

function check_test() {
    var context = "";
    for (var i = 0; i < tables.length; i++) {
        context += tables[i];
    }
    for (var i = 0; i < tests[0].length; i++) {
        context += tests[my_test][i];
    }
    var query = document.getElementById("query").value;
    sql_run(context,query,["test",my_test]);
}

function check() {
    document.getElementById("verdict").innerHTML = "";
    my_test = 0;
    check_test();
}

read_task("tasks/task2.txt");

</script>
